# Ember CSS Modules/Embroider issue reproduction

```
yarn install
./script/apply-hacks.sh
cd packages/host-app
ember s
```

<details>
<summary><i>Stack trace for the first time htmlbars-plugin is instantiated for bar.hbs with the incorrect moduleName (templates/components/bar.hbs)</i></summary>
<pre>ClassTransformPlugin (/Users/lenny/Desktop/demos/embroider/node_modules/ember-css-modules/lib/htmlbars-plugin/index.js:10)
plugin.semver.lt.options (/Users/lenny/Desktop/demos/embroider/node_modules/ember-css-modules/lib/htmlbars-plugin/index.js:23)
preprocess (VM3652:5486)
applyTransforms (/Users/lenny/Desktop/demos/embroider/node_modules/@embroider/core/src/template-compiler.ts:240)
processString (/Users/lenny/Desktop/demos/embroider/node_modules/@embroider/core/src/template-compiler.ts:299)
resolve (/Users/lenny/Desktop/demos/embroider/node_modules/@embroider/core/node_modules/broccoli-persistent-filter/lib/strategies/persistent.js:45)
initializePromise (-internal.js:236)
Promise (promise.js:142)
cache.get.then.entry (/Users/lenny/Desktop/demos/embroider/node_modules/@embroider/core/node_modules/broccoli-persistent-filter/lib/strategies/persistent.js:44)
tryCatch (-internal.js:198)
invokeCallback (-internal.js:211)
publish (-internal.js:181)
flush (asap.js:80)
processTicksAndRejections (task_queues.js:79)
[ TickObject ] (Unknown Source:undefined)
init (inspector_async_hook.js:21)
emitInitNative (async_hooks.js:132)
emitInitScript (async_hooks.js:331)
TickObject (task_queues.js:104)
nextTick (task_queues.js:135)
(anonymous function) (asap.js:33)
asap (asap.js:11)
reject (-internal.js:142)
args.(anonymous function) (node.js:221)
readFileAfterOpen (fs.js:242)
[ FSREQCALLBACK ] (Unknown Source:undefined)
init (inspector_async_hook.js:21)
emitInitNative (async_hooks.js:132)
readFile (fs.js:289)
tryApply (node.js:23)
handleValueInput (node.js:237)
fn (node.js:227)
(anonymous function) (/Users/lenny/Desktop/demos/embroider/node_modules/async-disk-cache/index.js:196)
obj.(anonymous function) (/Users/lenny/Desktop/demos/embroider/node_modules/async-disk-cache/index.js:51)
processString (/Users/lenny/Desktop/demos/embroider/node_modules/@embroider/core/node_modules/broccoli-persistent-filter/lib/strategies/persistent.js:34)
processString (/Users/lenny/Desktop/demos/embroider/node_modules/@embroider/core/node_modules/broccoli-persistent-filter/lib/processor.js:19)
resolve (/Users/lenny/Desktop/demos/embroider/node_modules/@embroider/core/node_modules/broccoli-persistent-filter/index.js:353)
initializePromise (-internal.js:236)
Promise (promise.js:142)
invoke (/Users/lenny/Desktop/demos/embroider/node_modules/@embroider/core/node_modules/broccoli-persistent-filter/index.js:352)
Filter.processFile (/Users/lenny/Desktop/demos/embroider/node_modules/@embroider/core/node_modules/broccoli-persistent-filter/index.js:371)
Promise.resolve.then (/Users/lenny/Desktop/demos/embroider/node_modules/@embroider/core/node_modules/broccoli-persistent-filter/index.js:337)
tryCatcher (-internal.js:39)
invokeCallback (-internal.js:211)
(anonymous function) (then.js:26)
flush (asap.js:80)
processTicksAndRejections (task_queues.js:79)
[ TickObject ] (Unknown Source:undefined)
init (inspector_async_hook.js:21)
emitInitNative (async_hooks.js:132)
emitInitScript (async_hooks.js:331)
TickObject (task_queues.js:104)
nextTick (task_queues.js:135)
(anonymous function) (asap.js:33)
asap (asap.js:11)
then (then.js:25)
Filter.processAndCacheFile (/Users/lenny/Desktop/demos/embroider/node_modules/@embroider/core/node_modules/broccoli-persistent-filter/index.js:336)
resolve (/Users/lenny/Desktop/demos/embroider/node_modules/@embroider/core/node_modules/broccoli-persistent-filter/index.js:238)
initializePromise (-internal.js:236)
Promise (promise.js:142)
Filter._handleFile (/Users/lenny/Desktop/demos/embroider/node_modules/@embroider/core/node_modules/broccoli-persistent-filter/index.js:228)
createOperation (/Users/lenny/Desktop/demos/embroider/node_modules/@embroider/core/node_modules/broccoli-persistent-filter/index.js:202)
patch (/Users/lenny/Desktop/demos/embroider/node_modules/@embroider/core/node_modules/broccoli-persistent-filter/index.js:208)
(anonymous function) (/Users/lenny/Desktop/demos/embroider/node_modules/promise-map-series/index.js:11)
tryCatch (-internal.js:198)
invokeCallback (-internal.js:211)
publish (-internal.js:181)
flush (asap.js:80)
processTicksAndRejections (task_queues.js:79)
[ TickObject ] (Unknown Source:undefined)
init (inspector_async_hook.js:21)
emitInitNative (async_hooks.js:132)
emitInitScript (async_hooks.js:331)
TickObject (task_queues.js:104)
nextTick (task_queues.js:135)
(anonymous function) (asap.js:33)
asap (asap.js:11)
fulfill (-internal.js:132)
resolve (-internal.js:107)
(anonymous function) (-internal.js:47)
tryCatcher (-internal.js:39)
invokeCallback (-internal.js:211)
publish (-internal.js:197)
flush (asap.js:80)
processTicksAndRejections (task_queues.js:79)
</pre>
</details>

<details>
<summary><i>Stack trace for the second time htmlbars-plugin is instantiated for bar.hbs with the embroider temp directory prefix</i></summary>
<pre>ClassTransformPlugin (/Users/lenny/Desktop/demos/embroider/node_modules/ember-css-modules/lib/htmlbars-plugin/index.js:10)
plugin.semver.lt.options (/Users/lenny/Desktop/demos/embroider/node_modules/ember-css-modules/lib/htmlbars-plugin/index.js:23)
preprocess (VM3845:5662)
precompile (VM3845:3797)
precompile (VM3845:7655)
precompile (/Users/lenny/Desktop/demos/embroider/node_modules/@embroider/core/src/template-compiler.ts:199)
compile (/Users/lenny/Desktop/demos/embroider/node_modules/@embroider/core/src/template-compiler.ts:214)
hbsLoader (/Users/lenny/Desktop/demos/embroider/node_modules/@embroider/webpack/src/webpack-hbs-loader.ts:11)
LOADER_EXECUTION (/Users/lenny/Desktop/demos/embroider/node_modules/loader-runner/lib/LoaderRunner.js:119)
runSyncOrAsync (/Users/lenny/Desktop/demos/embroider/node_modules/loader-runner/lib/LoaderRunner.js:120)
iterateNormalLoaders (/Users/lenny/Desktop/demos/embroider/node_modules/loader-runner/lib/LoaderRunner.js:232)
(anonymous function) (/Users/lenny/Desktop/demos/embroider/node_modules/loader-runner/lib/LoaderRunner.js:205)
finished (/Users/lenny/Desktop/demos/embroider/node_modules/enhanced-resolve/lib/CachedInputFileSystem.js:43)
provider (/Users/lenny/Desktop/demos/embroider/node_modules/enhanced-resolve/lib/CachedInputFileSystem.js:79)
(anonymous function) (/Users/lenny/Desktop/demos/embroider/node_modules/graceful-fs/graceful-fs.js:90)
readFileAfterClose (read_file_context.js:54)
[ FSREQCALLBACK ] (Unknown Source:undefined)
init (inspector_async_hook.js:21)
emitInitNative (async_hooks.js:132)
close (read_file_context.js:93)
readFileAfterRead (read_file_context.js:22)
[ FSREQCALLBACK ] (Unknown Source:undefined)
init (inspector_async_hook.js:21)
emitInitNative (async_hooks.js:132)
read (read_file_context.js:85)
readFileAfterStat (fs.js:278)
[ FSREQCALLBACK ] (Unknown Source:undefined)
init (inspector_async_hook.js:21)
emitInitNative (async_hooks.js:132)
readFileAfterOpen (fs.js:248)
[ FSREQCALLBACK ] (Unknown Source:undefined)
init (inspector_async_hook.js:21)
emitInitNative (async_hooks.js:132)
readFile (fs.js:289)
go$readFile (/Users/lenny/Desktop/demos/embroider/node_modules/graceful-fs/graceful-fs.js:85)
readFile (/Users/lenny/Desktop/demos/embroider/node_modules/graceful-fs/graceful-fs.js:82)
provide (/Users/lenny/Desktop/demos/embroider/node_modules/enhanced-resolve/lib/CachedInputFileSystem.js:78)
readFile (/Users/lenny/Desktop/demos/embroider/node_modules/enhanced-resolve/lib/CachedInputFileSystem.js:239)
processResource (/Users/lenny/Desktop/demos/embroider/node_modules/loader-runner/lib/LoaderRunner.js:202)
iteratePitchingLoaders (/Users/lenny/Desktop/demos/embroider/node_modules/loader-runner/lib/LoaderRunner.js:158)
iteratePitchingLoaders (/Users/lenny/Desktop/demos/embroider/node_modules/loader-runner/lib/LoaderRunner.js:165)
(anonymous function) (/Users/lenny/Desktop/demos/embroider/node_modules/loader-runner/lib/LoaderRunner.js:176)
loadLoader (/Users/lenny/Desktop/demos/embroider/node_modules/loader-runner/lib/loadLoader.js:47)
iteratePitchingLoaders (/Users/lenny/Desktop/demos/embroider/node_modules/loader-runner/lib/LoaderRunner.js:169)
runLoaders (/Users/lenny/Desktop/demos/embroider/node_modules/loader-runner/lib/LoaderRunner.js:365)
doBuild (/Users/lenny/Desktop/demos/embroider/node_modules/webpack/lib/NormalModule.js:280)
build (/Users/lenny/Desktop/demos/embroider/node_modules/webpack/lib/NormalModule.js:427)
buildModule (/Users/lenny/Desktop/demos/embroider/node_modules/webpack/lib/Compilation.js:633)
factory.create (/Users/lenny/Desktop/demos/embroider/node_modules/webpack/lib/Compilation.js:882)
factory (/Users/lenny/Desktop/demos/embroider/node_modules/webpack/lib/NormalModuleFactory.js:405)
hooks.afterResolve.callAsync (/Users/lenny/Desktop/demos/embroider/node_modules/webpack/lib/NormalModuleFactory.js:155)
(anonymous function) (VM3776:6)
resolver (/Users/lenny/Desktop/demos/embroider/node_modules/webpack/lib/NormalModuleFactory.js:138)
process.nextTick (/Users/lenny/Desktop/demos/embroider/node_modules/webpack/lib/NormalModuleFactory.js:342)
processTicksAndRejections (task_queues.js:79)
</pre>
</details>
